name: Notify

on:
  workflow_run:
    workflows: [ "pages-build-deployment" ]
    types:
      - completed
jobs:
  notify:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Find the latest CI run
        uses: actions/github-script@v6
        id: find_ci_run
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50,
            });
            const ciRuns = runs.data.workflow_runs
              .filter(run => run.name === "CI" && run.status === "completed" && (run.conclusion === "success" || run.conclusion === "failure"))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const latestCiRun = ciRuns[0];
            const runNumber = latestCiRun.run_number;
            core.setOutput("run_number", runNumber);
            core.setOutput("run_id", latestCiRun.id);
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gnuplot jq

      - name: Fetch test results from Allure report
        run: |
          REPORT_URL="https://evgnick.github.io/JenkinsQA_2024_fall2/${{ steps.find_ci_run.outputs.run_number }}/widgets/summary.json"
          wget -q -O summary.json "$REPORT_URL"

          PASSED=$(jq '.statistic.passed' summary.json)
          FAILED=$(jq '.statistic.failed' summary.json)
          BROKEN=$(jq '.statistic.broken' summary.json)
          SKIPPED=$(jq '.statistic.skipped' summary.json)
          TOTAL=$(jq '.statistic.total' summary.json)
          DURATION=$(jq '.time.duration' summary.json)
          DURATION_FINAL=$(date -ud @$((DURATION / 1000)) +'%M:%S')

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "BROKEN=$BROKEN" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "DURATION_FINAL=$DURATION_FINAL" >> $GITHUB_ENV

      - name: Generate test results chart
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É–≥–ª—ã —Å–µ–∫—Ç–æ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤
          TOTAL_SUM=$((PASSED + FAILED + BROKEN + SKIPPED))
          if [ "$TOTAL_SUM" -eq 0 ]; then
            echo "–ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã."
            exit 1
          fi

          ANGLE_PASSED=$(echo "360 * $PASSED / $TOTAL_SUM" | bc -l)
          ANGLE_FAILED=$(echo "360 * $FAILED / $TOTAL_SUM" | bc -l)
          ANGLE_BROKEN=$(echo "360 * $BROKEN / $TOTAL_SUM" | bc -l)
          ANGLE_SKIPPED=$(echo "360 * $SKIPPED / $TOTAL_SUM" | bc -l)

          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è gnuplot
          cat <<EOF > angles.dat
          0 $ANGLE_PASSED "green" "Passed"
          $ANGLE_PASSED $(echo "$ANGLE_PASSED + $ANGLE_FAILED" | bc -l) "red" "Failed"
          $(echo "$ANGLE_PASSED + $ANGLE_FAILED" | bc -l) $(echo "$ANGLE_PASSED + $ANGLE_FAILED + $ANGLE_BROKEN" | bc -l) "orange" "Broken"
          $(echo "$ANGLE_PASSED + $ANGLE_FAILED + $ANGLE_BROKEN" | bc -l) 360 "blue" "Skipped"
          EOF

          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É
          gnuplot -persist <<-EOF
            set terminal pngcairo enhanced size 600,400;
            set output 'test_results_chart.png';
            set title 'Allure Test Results';
            set style fill solid 1.0;
            unset key;
            unset border;
            unset tics;
            set xrange [-1.1:1.1];
            set yrange [-1.1:1.1];

            set palette model RGB defined (0 "green", 1 "red", 2 "orange", 3 "blue")

            plot 'angles.dat' using 1:2:3:4 with filledcurves lc palette title columnheader(4)
          EOF
        shell: /usr/bin/bash -e {0}
        env:
          PASSED: $PASSED
          FAILED: $FAILED
          BROKEN: $BROKEN
          SKIPPED: $SKIPPED
          TOTAL: $TOTAL
          DURATION_FINAL: $DURATION_FINAL

      - name: Send Telegram Notification
        run: |
          REPORT_LINK="https://evgnick.github.io/JenkinsQA_2024_fall2/${{ steps.find_ci_run.outputs.run_number }}/"
          CI_RUN_LINK="https://github.com/evgnick/JenkinsQA_2024_fall2/actions/runs/${{ steps.find_ci_run.outputs.run_id }}"
          
          TIMESTAMP=$(date +"%Y.%m.%d %H:%M:%S")
          
          ESCAPED_REPORT_LINK=$(echo "$REPORT_LINK" | sed 's|\.|\\.|g; s|-|\\-|g; s|_|\\_|g; s|:|\\:|g; s|/|\\/|g')
          ESCAPED_CI_RUN_LINK=$(echo "$CI_RUN_LINK" | sed 's|\.|\\.|g; s|-|\\-|g; s|_|\\_|g; s|:|\\:|g; s|/|\\/|g')
          ESCAPED_TIMESTAMP=$(echo "$TIMESTAMP" | sed 's|-|\\-|g; s|\.|\\.|g')
          
          MESSAGE="üìù –û—Ç—á–µ—Ç: [–æ—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç](${ESCAPED_REPORT_LINK})
          üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${ESCAPED_TIMESTAMP}
          üî¢ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: $TOTAL
          ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö: $PASSED
          ‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö: $FAILED
          ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö: $BROKEN
          ‚è∏Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö: $SKIPPED
          ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $DURATION_FINAL
          üîó –ó–∞–ø—É—Å–∫: [–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—É—Å–∫](${ESCAPED_CI_RUN_LINK})"
          
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | sed 's|*|\\*|g; s|_|\\_|g; s|~|\\~|g')
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendPhoto" \
          -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -F photo="@test_results_chart.png" \
          -F caption="$ESCAPED_MESSAGE" \
          -F parse_mode="MarkdownV2"

#      - name: Send Telegram Notification
#        run: |
#          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
#          REPORT_LINK="https://evgnick.github.io/JenkinsQA_2024_fall2/${{ steps.find_ci_run.outputs.run_number }}/"
#          CI_RUN_LINK="https://github.com/${{ github.repository }}/actions/runs/${{ steps.find_ci_run.outputs.run_id }}"
#
#          ESCAPED_TIMESTAMP=$(echo "$TIMESTAMP" | sed 's|-|\\-|g; s|:|\\:|g; s|\.|\\.|g; s|_|\\_|g; s|/|\\/|g')
#          ESCAPED_REPORT_LINK=$(echo "$REPORT_LINK" | sed 's|-|\\-|g; s|\.|\\.|g; s|_|\\_|g; s|:|\\:|g; s|/|\\/|g')
#          ESCAPED_CI_RUN_LINK=$(echo "$CI_RUN_LINK" | sed 's|-|\\-|g; s|\.|\\.|g; s|_|\\_|g; s|:|\\:|g; s|/|\\/|g')
#
#          MESSAGE="üìù –ù–æ–≤—ã–π –æ—Ç—á–µ—Ç Allure: [–æ—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç](${ESCAPED_REPORT_LINK})%0AüìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${ESCAPED_TIMESTAMP}%0A‚öôÔ∏è –°–±–æ—Ä–∫–∞: ${{ steps.find_ci_run.outputs.run_number }}%0Aüîó –ó–∞–ø—É—Å–∫: [–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—É—Å–∫](${ESCAPED_CI_RUN_LINK})"
#
#          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
#            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
#            -d text="${MESSAGE}" \
#            -d parse_mode="MarkdownV2"

#      - name: Send Slack Notification
#        run: |
#          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
#          REPORT_LINK="https://evgnick.github.io/JenkinsQA_2024_fall2/${{ steps.find_ci_run.outputs.run_number }}/"
#          CI_RUN_LINK="https://github.com/${{ github.repository }}/actions/runs/${{ steps.find_ci_run.outputs.run_id }}"
#
#          MESSAGE="*–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç Allure*\nüìÖ *–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è*: $TIMESTAMP\n‚öôÔ∏è *–°–±–æ—Ä–∫–∞*: ${{ steps.find_ci_run.outputs.run_number }}\nüîó *<$REPORT_LINK|–û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç>*\nüîó *<$CI_RUN_LINK|–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø—É—Å–∫>*"
#
#          curl -X POST -H 'Content-type: application/json' \
#            --data "{\"text\": \"$MESSAGE\"}" \
#            ${{ secrets.SLACK_WEBHOOK_URL }}
